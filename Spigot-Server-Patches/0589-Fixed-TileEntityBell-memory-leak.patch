From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: giacomo <32515303+giacomozama@users.noreply.github.com>
Date: Sat, 10 Oct 2020 12:15:33 +0200
Subject: [PATCH] Fixed TileEntityBell memory leak

TileEntityBell has a list of entities (entitiesAtRing) that was not being cleared at the right time, causing leaks whenever a bell would be rung near a crowd of entities.

diff --git a/src/main/java/net/minecraft/world/level/block/entity/BellBlockEntity.java b/src/main/java/net/minecraft/world/level/block/entity/BellBlockEntity.java
index 113a9dcd2c1f13cee285db98590c7cb7db8512c7..ca50dcb23fc6e11ca00ac4ba445acd4471efd836 100644
--- a/src/main/java/net/minecraft/world/level/block/entity/BellBlockEntity.java
+++ b/src/main/java/net/minecraft/world/level/block/entity/BellBlockEntity.java
@@ -23,8 +23,8 @@ public class BellBlockEntity extends BlockEntity implements TickableBlockEntity
     public int ticks;
     public boolean shaking;
     public Direction clickDirection;
-    private List<LivingEntity> nearbyEntities;
-    private boolean resonating;
+    private List<LivingEntity> nearbyEntities; private List<LivingEntity> getEntitiesAtRing() { return this.nearbyEntities; } // Paper - OBFHELPER
+    private boolean resonating; private boolean getShouldReveal() { return this.resonating; } // Paper - OBFHELPER
     private int resonationTicks;
 
     public BellBlockEntity() {
@@ -53,6 +53,11 @@ public class BellBlockEntity extends BlockEntity implements TickableBlockEntity
 
         if (this.ticks >= 50) {
             this.shaking = false;
+            // Paper start
+            if (!this.getShouldReveal()) {
+                this.getEntitiesAtRing().clear();
+            }
+            // Paper end
             this.ticks = 0;
         }
 
@@ -67,6 +72,7 @@ public class BellBlockEntity extends BlockEntity implements TickableBlockEntity
             } else {
                 this.makeRaidersGlow(this.level);
                 this.showBellParticles(this.level);
+                this.getEntitiesAtRing().clear(); // Paper
                 this.resonating = false;
             }
         }
@@ -105,6 +111,7 @@ public class BellBlockEntity extends BlockEntity implements TickableBlockEntity
             }
         }
 
+        this.getEntitiesAtRing().removeIf(e -> !e.isAlive()); // Paper
     }
 
     private boolean areRaidersNearby() {
