From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Spottedleaf <Spottedleaf@users.noreply.github.com>
Date: Sun, 10 May 2020 22:49:05 -0400
Subject: [PATCH] Optimize WorldBorder collision checks and air


diff --git a/src/main/java/net/minecraft/world/entity/Entity.java b/src/main/java/net/minecraft/world/entity/Entity.java
index 067dffc4408f188dece4e6c9b7705b82ca6dc810..a20eefa08d239556bfd47bf15da2fa72d188cb58 100644
--- a/src/main/java/net/minecraft/world/entity/Entity.java
+++ b/src/main/java/net/minecraft/world/entity/Entity.java
@@ -105,7 +105,6 @@ import net.minecraft.world.phys.AABB;
 import net.minecraft.world.phys.HitResult;
 import net.minecraft.world.phys.Vec2;
 import net.minecraft.world.phys.Vec3;
-import net.minecraft.world.phys.shapes.BooleanOp;
 import net.minecraft.world.phys.shapes.CollisionContext;
 import net.minecraft.world.phys.shapes.Shapes;
 import net.minecraft.world.phys.shapes.VoxelShape;
@@ -911,7 +910,7 @@ public abstract class Entity implements Nameable, CommandSource, KeyedObject { /
         AABB axisalignedbb = this.getBoundingBox();
         CollisionContext voxelshapecollision = CollisionContext.of(this);
         VoxelShape voxelshape = this.level.getWorldBorder().getCollisionShape();
-        Stream<VoxelShape> stream = Shapes.joinIsNotEmpty(voxelshape, Shapes.create(axisalignedbb.deflate(1.0E-7D)), BooleanOp.AND) ? Stream.empty() : Stream.of(voxelshape);
+        Stream<VoxelShape> stream = !this.level.getWorldBorder().isInBounds(axisalignedbb) ? Stream.empty() : Stream.of(voxelshape); // Paper
         Stream<VoxelShape> stream1 = this.level.getEntityCollisions(this, axisalignedbb.expandTowards(movement), (entity) -> {
             return true;
         });
diff --git a/src/main/java/net/minecraft/world/level/CollisionSpliterator.java b/src/main/java/net/minecraft/world/level/CollisionSpliterator.java
index 72f33a2c6733b9df5c1e7ac8ceef54ca56a6bca1..158444f2daceb82514873a53c7ac228a1a5f8f2e 100644
--- a/src/main/java/net/minecraft/world/level/CollisionSpliterator.java
+++ b/src/main/java/net/minecraft/world/level/CollisionSpliterator.java
@@ -137,9 +137,10 @@ public class CollisionSpliterator extends AbstractSpliterator<VoxelShape> {
         WorldBorder worldBorder = this.collisionGetter.getWorldBorder();
         AABB aABB = this.source.getBoundingBox();
         if (!isBoxFullyWithinWorldBorder(worldBorder, aABB)) {
-            VoxelShape voxelShape = worldBorder.getCollisionShape();
-            if (!isOutsideBorder(voxelShape, aABB) && isCloseToBorder(voxelShape, aABB)) {
-                consumer.accept(voxelShape);
+            // Paper start
+            if (worldBorder.isInBounds(aABB.deflate(1.0E-7D)) && !worldBorder.isInBounds(aABB.grow(1.0E-7D))) {
+                consumer.accept(worldBorder.asVoxelShape());
+                // Paper end
                 return true;
             }
         }
diff --git a/src/main/java/net/minecraft/world/level/border/WorldBorder.java b/src/main/java/net/minecraft/world/level/border/WorldBorder.java
index f69a527ee095e8a09eea00e88fa31f10114b6bb8..8f000a499af2070cc1b4158fbee9c38db6df6608 100644
--- a/src/main/java/net/minecraft/world/level/border/WorldBorder.java
+++ b/src/main/java/net/minecraft/world/level/border/WorldBorder.java
@@ -53,6 +53,7 @@ public class WorldBorder {
         return (double) pos.getMaxBlockX() > this.getMinX() && (double) pos.getMinBlockX() < this.getMaxX() && (double) pos.getMaxBlockZ() > this.getMinZ() && (double) pos.getMinBlockZ() < this.getMaxZ();
     }
 
+    public final boolean isInBounds(AABB aabb) { return this.isWithinBounds(aabb); } // Paper - OBFHELPER
     public boolean isWithinBounds(AABB box) {
         return box.maxX > this.getMinX() && box.minX < this.getMaxX() && box.maxZ > this.getMinZ() && box.minZ < this.getMaxZ();
     }
diff --git a/src/main/java/net/minecraft/world/phys/shapes/Shapes.java b/src/main/java/net/minecraft/world/phys/shapes/Shapes.java
index 7cff896703c2453f34eacc24345cd0dc22642b12..3d66e8962eb53316f3383f8fcb6b9482d86f1fba 100644
--- a/src/main/java/net/minecraft/world/phys/shapes/Shapes.java
+++ b/src/main/java/net/minecraft/world/phys/shapes/Shapes.java
@@ -237,7 +237,7 @@ public final class Shapes {
                                 mutableBlockPos.set(axisCycle, q, r, p);
                                 BlockState blockState = world.getTypeIfLoaded(mutableBlockPos); // Paper
                                 if (mutableBlockPos == null) return 0.0D; // Paper
-                                if ((s != 1 || blockState.hasLargeCollisionShape()) && (s != 2 || blockState.is(Blocks.MOVING_PISTON))) {
+                                if (!blockState.isAir() && (s != 1 || blockState.hasLargeCollisionShape()) && (s != 2 || blockState.is(Blocks.MOVING_PISTON))) { // Paper
                                     initial = blockState.getCollisionShape(world, mutableBlockPos, context).collide(axis3, box.move((double)(-mutableBlockPos.getX()), (double)(-mutableBlockPos.getY()), (double)(-mutableBlockPos.getZ())), initial);
                                     if (Math.abs(initial) < 1.0E-7D) {
                                         return 0.0D;
