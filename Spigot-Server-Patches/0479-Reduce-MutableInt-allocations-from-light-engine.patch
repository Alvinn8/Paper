From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Spottedleaf <spottedleaf@spottedleaf.dev>
Date: Mon, 27 Apr 2020 02:48:06 -0700
Subject: [PATCH] Reduce MutableInt allocations from light engine

We can abuse the fact light is single threaded and share an instance
per light engine instance

diff --git a/src/main/java/net/minecraft/world/level/lighting/BlockLightEngine.java b/src/main/java/net/minecraft/world/level/lighting/BlockLightEngine.java
index d1ee57950aa9dfde9dbfe47bb7c363321c47423e..975ddeb715c32359722d3fad1c37b33bb20d6770 100644
--- a/src/main/java/net/minecraft/world/level/lighting/BlockLightEngine.java
+++ b/src/main/java/net/minecraft/world/level/lighting/BlockLightEngine.java
@@ -15,6 +15,7 @@ import org.apache.commons.lang3.mutable.MutableInt;
 public final class BlockLightEngine extends LayerLightEngine<BlockLightSectionStorage.BlockDataLayerStorageMap, BlockLightSectionStorage> {
     private static final Direction[] DIRECTIONS = Direction.values();
     private final BlockPos.MutableBlockPos pos = new BlockPos.MutableBlockPos();
+    private final MutableInt mutableInt = new MutableInt(); // Paper
 
     public BlockLightEngine(LightChunkGetter chunkProvider) {
         super(chunkProvider, LightLayer.BLOCK, new BlockLightSectionStorage(chunkProvider));
@@ -43,7 +44,7 @@ public final class BlockLightEngine extends LayerLightEngine<BlockLightSectionSt
             if (direction == null) {
                 return 15;
             } else {
-                MutableInt mutableInt = new MutableInt();
+                //MutableInt mutableInt = new MutableInt(); // Paper - share mutableint, single threaded
                 BlockState blockState = this.getStateAndOpacity(m, mutableInt);
                 if (mutableInt.getValue() >= 15) {
                     return 15;
diff --git a/src/main/java/net/minecraft/world/level/lighting/SkyLightEngine.java b/src/main/java/net/minecraft/world/level/lighting/SkyLightEngine.java
index ba1d141fdd0bb21f48a8f84d0d0748a4032e2932..29f183c5c65a0751f36c20f5cee6fba9991e1f9c 100644
--- a/src/main/java/net/minecraft/world/level/lighting/SkyLightEngine.java
+++ b/src/main/java/net/minecraft/world/level/lighting/SkyLightEngine.java
@@ -14,6 +14,7 @@ import org.apache.commons.lang3.mutable.MutableInt;
 public final class SkyLightEngine extends LayerLightEngine<SkyLightSectionStorage.SkyDataLayerStorageMap, SkyLightSectionStorage> {
     private static final Direction[] DIRECTIONS = Direction.values();
     private static final Direction[] HORIZONTALS = new Direction[]{Direction.NORTH, Direction.SOUTH, Direction.WEST, Direction.EAST};
+    private final MutableInt mutableInt = new MutableInt(); // Paper
 
     public SkyLightEngine(LightChunkGetter chunkProvider) {
         super(chunkProvider, LightLayer.SKY, new SkyLightSectionStorage(chunkProvider));
@@ -34,7 +35,7 @@ public final class SkyLightEngine extends LayerLightEngine<SkyLightSectionStorag
             if (i >= 15) {
                 return i;
             } else {
-                MutableInt mutableInt = new MutableInt();
+                //MutableInt mutableInt = new MutableInt(); // Paper - share mutableint, single threaded
                 BlockState blockState = this.getStateAndOpacity(m, mutableInt);
                 if (mutableInt.getValue() >= 15) {
                     return 15;
