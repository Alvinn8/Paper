From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Zach Brown <zach.brown@destroystokyo.com>
Date: Tue, 16 May 2017 21:29:08 -0500
Subject: [PATCH] Add option to make parrots stay on shoulders despite movement

Makes parrots not fall off whenever the player changes height, or touches water, or gets hit by a passing leaf.
Instead, switches the behavior so that players have to sneak to make the birds leave.

I suspect Mojang may switch to this behavior before full release.

To be converted into a Paper-API event at some point in the future?

diff --git a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
index 11106a20ccc161f18c1d5491785e44bb84f8a821..7f22cdc26d26d6d937506f901a8a0ed1d0a9f780 100644
--- a/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
+++ b/src/main/java/com/destroystokyo/paper/PaperWorldConfig.java
@@ -324,4 +324,10 @@ public class PaperWorldConfig {
         maxCollisionsPerEntity = getInt( "max-entity-collisions", this.spigotConfig.getInt("max-entity-collisions", 8) );
         log( "Max Entity Collisions: " + maxCollisionsPerEntity );
     }
+
+    public boolean parrotsHangOnBetter;
+    private void parrotsHangOnBetter() {
+        parrotsHangOnBetter = getBoolean("parrots-are-unaffected-by-player-movement", false);
+        log("Parrots are unaffected by player movement: " + parrotsHangOnBetter);
+    }
 }
diff --git a/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java b/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
index 981787bba37af4c3332a0b866e41628a392690eb..1ae6587c7ff75eaa6fcb3e3c7b1a321f72bb067d 100644
--- a/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
+++ b/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
@@ -2047,6 +2047,13 @@ public class ServerGamePacketListenerImpl implements ServerGamePacketListener {
         switch (packetplayinentityaction.getAction()) {
             case PRESS_SHIFT_KEY:
                 this.player.setShiftKeyDown(true);
+
+            // Paper start - Hang on!
+            if (this.player.level.paperConfig.parrotsHangOnBetter) {
+                this.player.removeEntitiesOnShoulder();
+            }
+            // Paper end
+
                 break;
             case RELEASE_SHIFT_KEY:
                 this.player.setShiftKeyDown(false);
diff --git a/src/main/java/net/minecraft/world/entity/player/Player.java b/src/main/java/net/minecraft/world/entity/player/Player.java
index c38fa27cfa71d2886ddda3683463f9219be7ba9a..6a559af2db29c6ebb10d628c73985b439164f62c 100644
--- a/src/main/java/net/minecraft/world/entity/player/Player.java
+++ b/src/main/java/net/minecraft/world/entity/player/Player.java
@@ -529,7 +529,7 @@ public abstract class Player extends LivingEntity {
         this.playShoulderEntityAmbientSound(this.getShoulderEntityLeft());
         this.playShoulderEntityAmbientSound(this.getShoulderEntityRight());
         if (!this.level.isClientSide && (this.fallDistance > 0.5F || this.isInWater()) || this.abilities.flying || this.isSleeping()) {
-            this.removeEntitiesOnShoulder();
+            if (!this.level.paperConfig.parrotsHangOnBetter) this.removeEntitiesOnShoulder(); // Paper - Hang on!
         }
 
     }
@@ -1862,7 +1862,7 @@ public abstract class Player extends LivingEntity {
         }
     }
 
-    protected void removeEntitiesOnShoulder() {
+    public void removeEntitiesOnShoulder() { // Paper - public
         if (this.timeEntitySatOnShoulder + 20L < this.level.getGameTime()) {
             // CraftBukkit start
             if (this.spawnEntityFromShoulder(this.getShoulderEntityLeft())) {
