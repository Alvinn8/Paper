From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: mezz <tehgeek@gmail.com>
Date: Wed, 9 Aug 2017 17:51:22 -0500
Subject: [PATCH] Fix MC-117075: TE Unload Lag Spike


diff --git a/src/main/java/net/minecraft/world/level/Level.java b/src/main/java/net/minecraft/world/level/Level.java
index 178a6cfb5974883b9adca4cc5d46ebce978ce299..e0da6e885ab098c90ca890b4b5799a6f01bec2d4 100644
--- a/src/main/java/net/minecraft/world/level/Level.java
+++ b/src/main/java/net/minecraft/world/level/Level.java
@@ -727,7 +727,11 @@ public abstract class Level implements LevelAccessor, AutoCloseable {
         gameprofilerfiller.push("blockEntities");
         timings.tileEntityTick.startTiming(); // Spigot
         if (!this.tileEntityListUnload.isEmpty()) {
-            this.tickableBlockEntities.removeAll(this.tileEntityListUnload);
+            // Paper start - Use alternate implementation with faster contains
+            java.util.Set<BlockEntity> toRemove = java.util.Collections.newSetFromMap(new java.util.IdentityHashMap<>());
+            toRemove.addAll(tileEntityListUnload);
+            this.tickableBlockEntities.removeAll(toRemove);
+            // Paper end
             //this.tileEntityList.removeAll(this.tileEntityListUnload); // Paper - remove unused list
             this.tileEntityListUnload.clear();
         }
