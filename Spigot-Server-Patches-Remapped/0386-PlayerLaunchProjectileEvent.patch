From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: BillyGalbreath <Blake.Galbreath@GMail.com>
Date: Sat, 21 Jul 2018 03:11:03 -0500
Subject: [PATCH] PlayerLaunchProjectileEvent


diff --git a/src/main/java/net/minecraft/world/InteractionResultHolder.java b/src/main/java/net/minecraft/world/InteractionResultHolder.java
index 3bc22b977e00c1901a9025112e354e59fcc08a74..c12e2a65d30ca22db0c522e4b245009bcc38c4f4 100644
--- a/src/main/java/net/minecraft/world/InteractionResultHolder.java
+++ b/src/main/java/net/minecraft/world/InteractionResultHolder.java
@@ -10,6 +10,7 @@ public class InteractionResultHolder<T> {
         this.object = value;
     }
 
+    public InteractionResult getResult() { return this.getResult(); } // Paper - OBFHELPER
     public InteractionResult getResult() {
         return this.result;
     }
diff --git a/src/main/java/net/minecraft/world/item/EggItem.java b/src/main/java/net/minecraft/world/item/EggItem.java
index 597855d5148292b30b155128bb1e6a051be50b6b..0c804db6bdd45d968f872cef4743f717456c8a01 100644
--- a/src/main/java/net/minecraft/world/item/EggItem.java
+++ b/src/main/java/net/minecraft/world/item/EggItem.java
@@ -5,7 +5,9 @@ import net.minecraft.sounds.SoundEvents;
 import net.minecraft.sounds.SoundSource;
 import net.minecraft.stats.Stats;
 import net.minecraft.world.InteractionHand;
+import net.minecraft.world.InteractionResult;
 import net.minecraft.world.InteractionResultHolder;
+import net.minecraft.world.entity.Entity;
 import net.minecraft.world.entity.player.Player;
 import net.minecraft.world.entity.projectile.ThrownEgg;
 import net.minecraft.world.level.Level;
@@ -26,21 +28,35 @@ public class EggItem extends Item {
 
             entityegg.setItem(itemstack);
             entityegg.shootFromRotation(entityhuman, entityhuman.xRot, entityhuman.yRot, 0.0F, 1.5F, 1.0F);
-            // CraftBukkit start
-            if (!world.addFreshEntity(entityegg)) {
+            // Paper start
+            com.destroystokyo.paper.event.player.PlayerLaunchProjectileEvent event = new com.destroystokyo.paper.event.player.PlayerLaunchProjectileEvent((org.bukkit.entity.Player) entityhuman.getBukkitEntity(), org.bukkit.craftbukkit.inventory.CraftItemStack.asCraftMirror(itemstack), (org.bukkit.entity.Projectile) entityegg.getBukkitEntity());
+            if (event.callEvent() && world.addFreshEntity(entityegg)) {
+                if (event.shouldConsume() && !entityhuman.abilities.instabuild) {
+                    itemstack.shrink(1);
+                } else if (entityhuman instanceof ServerPlayer) {
+                    ((ServerPlayer) entityhuman).getBukkitEntity().updateInventory();
+                }
+
+                world.playSound((Player) null, entityhuman.getX(), entityhuman.getY(), entityhuman.getZ(), SoundEvents.EGG_THROW, SoundSource.PLAYERS, 0.5F, 0.4F / (Entity.SHARED_RANDOM.nextFloat() * 0.4F + 0.8F));
+                entityhuman.awardStat(Stats.ITEM_USED.get(this));
+            } else {
                 if (entityhuman instanceof ServerPlayer) {
                     ((ServerPlayer) entityhuman).getBukkitEntity().updateInventory();
                 }
-                return InteractionResultHolder.fail(itemstack);
+                return new InteractionResultHolder<ItemStack>(InteractionResult.FAIL, itemstack);
             }
-            // CraftBukkit end
+            // Paper end
+
+
         }
         world.playSound((Player) null, entityhuman.getX(), entityhuman.getY(), entityhuman.getZ(), SoundEvents.EGG_THROW, SoundSource.PLAYERS, 0.5F, 0.4F / (EggItem.random.nextFloat() * 0.4F + 0.8F)); // CraftBukkit - from above
 
-        entityhuman.awardStat(Stats.ITEM_USED.get(this));
-        if (!entityhuman.abilities.instabuild) {
-            itemstack.shrink(1);
+        /* // Paper start - moved up
+        entityhuman.b(StatisticList.ITEM_USED.b(this));
+        if (!entityhuman.abilities.canInstantlyBuild) {
+            itemstack.subtract(1);
         }
+        */ // Paper end
 
         return InteractionResultHolder.sidedSuccess(itemstack, world.isClientSide());
     }
diff --git a/src/main/java/net/minecraft/world/item/EnderpearlItem.java b/src/main/java/net/minecraft/world/item/EnderpearlItem.java
index d00918e6ab58998c95c9ccc103850bbfc525571a..3dd0cc2108006bf1e634967d5bb858bf271c72a0 100644
--- a/src/main/java/net/minecraft/world/item/EnderpearlItem.java
+++ b/src/main/java/net/minecraft/world/item/EnderpearlItem.java
@@ -7,6 +7,7 @@ import net.minecraft.stats.Stats;
 import net.minecraft.world.InteractionHand;
 import net.minecraft.world.InteractionResult;
 import net.minecraft.world.InteractionResultHolder;
+import net.minecraft.world.entity.Entity;
 import net.minecraft.world.entity.player.Player;
 import net.minecraft.world.entity.projectile.ThrownEnderpearl;
 import net.minecraft.world.level.Level;
@@ -27,22 +28,37 @@ public class EnderpearlItem extends Item {
 
             entityenderpearl.setItem(itemstack);
             entityenderpearl.shootFromRotation(entityhuman, entityhuman.xRot, entityhuman.yRot, 0.0F, 1.5F, 1.0F);
-            if (!world.addFreshEntity(entityenderpearl)) {
+            // Paper start
+                com.destroystokyo.paper.event.player.PlayerLaunchProjectileEvent event = new com.destroystokyo.paper.event.player.PlayerLaunchProjectileEvent((org.bukkit.entity.Player) entityhuman.getBukkitEntity(), org.bukkit.craftbukkit.inventory.CraftItemStack.asCraftMirror(itemstack), (org.bukkit.entity.Projectile) entityenderpearl.getBukkitEntity());
+            if (event.callEvent() && world.addFreshEntity(entityenderpearl)) {
+                if (event.shouldConsume() && !entityhuman.abilities.instabuild) {
+                    itemstack.shrink(1);
+                } else if (entityhuman instanceof ServerPlayer) {
+                    ((ServerPlayer) entityhuman).getBukkitEntity().updateInventory();
+                }
+
+                world.playSound((Player) null, entityhuman.getX(), entityhuman.getY(), entityhuman.getZ(), SoundEvents.ENDER_PEARL_THROW, SoundSource.NEUTRAL, 0.5F, 0.4F / (Entity.SHARED_RANDOM.nextFloat() * 0.4F + 0.8F));
+                entityhuman.awardStat(Stats.ITEM_USED.get(this));
+                entityhuman.getCooldowns().addCooldown(this, 20);
+            } else {
+                // Paper end
                 if (entityhuman instanceof ServerPlayer) {
                     ((ServerPlayer) entityhuman).getBukkitEntity().updateInventory();
                 }
-                return new InteractionResultHolder(InteractionResult.FAIL, itemstack);
+                return new InteractionResultHolder<ItemStack>(InteractionResult.FAIL, itemstack);
             }
         }
 
-        world.playSound((Player) null, entityhuman.getX(), entityhuman.getY(), entityhuman.getZ(), SoundEvents.ENDER_PEARL_THROW, SoundSource.NEUTRAL, 0.5F, 0.4F / (EnderpearlItem.random.nextFloat() * 0.4F + 0.8F));
-        entityhuman.getCooldowns().addCooldown(this, 20);
-        // CraftBukkit end
-
-        entityhuman.awardStat(Stats.ITEM_USED.get(this));
-        if (!entityhuman.abilities.instabuild) {
-            itemstack.shrink(1);
-        }
+        // Paper start - moved up
+//        world.playSound((EntityHuman) null, entityhuman.locX(), entityhuman.locY(), entityhuman.locZ(), SoundEffects.ENTITY_ENDER_PEARL_THROW, SoundCategory.NEUTRAL, 0.5F, 0.4F / (ItemEnderPearl.RANDOM.nextFloat() * 0.4F + 0.8F));
+//        entityhuman.getCooldownTracker().setCooldown(this, 20);
+//        // CraftBukkit end
+//
+//        entityhuman.b(StatisticList.ITEM_USED.b(this));
+//        if (!entityhuman.abilities.canInstantlyBuild) {
+//            itemstack.subtract(1);
+//        }
+        // Paper end - moved up
 
         return InteractionResultHolder.sidedSuccess(itemstack, world.isClientSide());
     }
diff --git a/src/main/java/net/minecraft/world/item/ExperienceBottleItem.java b/src/main/java/net/minecraft/world/item/ExperienceBottleItem.java
index 2af93576d10b164f690b1f0dd424e318ba076a34..50fb88ed547856bd3802e8117ef7e13ddfce9dcd 100644
--- a/src/main/java/net/minecraft/world/item/ExperienceBottleItem.java
+++ b/src/main/java/net/minecraft/world/item/ExperienceBottleItem.java
@@ -1,10 +1,13 @@
 package net.minecraft.world.item;
 
+import net.minecraft.server.level.ServerPlayer;
 import net.minecraft.sounds.SoundEvents;
 import net.minecraft.sounds.SoundSource;
 import net.minecraft.stats.Stats;
 import net.minecraft.world.InteractionHand;
+import net.minecraft.world.InteractionResult;
 import net.minecraft.world.InteractionResultHolder;
+import net.minecraft.world.entity.Entity;
 import net.minecraft.world.entity.player.Player;
 import net.minecraft.world.entity.projectile.ThrownExperienceBottle;
 import net.minecraft.world.level.Level;
@@ -24,19 +27,38 @@ public class ExperienceBottleItem extends Item {
     public InteractionResultHolder<ItemStack> use(Level world, Player entityhuman, InteractionHand enumhand) {
         ItemStack itemstack = entityhuman.getItemInHand(enumhand);
 
-        world.playSound((Player) null, entityhuman.getX(), entityhuman.getY(), entityhuman.getZ(), SoundEvents.EXPERIENCE_BOTTLE_THROW, SoundSource.NEUTRAL, 0.5F, 0.4F / (ExperienceBottleItem.random.nextFloat() * 0.4F + 0.8F));
+        //world.playSound((EntityHuman) null, entityhuman.locX(), entityhuman.locY(), entityhuman.locZ(), SoundEffects.ENTITY_EXPERIENCE_BOTTLE_THROW, SoundCategory.NEUTRAL, 0.5F, 0.4F / (ItemExpBottle.RANDOM.nextFloat() * 0.4F + 0.8F));  // Paper - moved down
         if (!world.isClientSide) {
             ThrownExperienceBottle entitythrownexpbottle = new ThrownExperienceBottle(world, entityhuman);
 
             entitythrownexpbottle.setItem(itemstack);
             entitythrownexpbottle.shootFromRotation(entityhuman, entityhuman.xRot, entityhuman.yRot, -20.0F, 0.7F, 1.0F);
-            world.addFreshEntity(entitythrownexpbottle);
+            // Paper start
+            com.destroystokyo.paper.event.player.PlayerLaunchProjectileEvent event = new com.destroystokyo.paper.event.player.PlayerLaunchProjectileEvent((org.bukkit.entity.Player) entityhuman.getBukkitEntity(), org.bukkit.craftbukkit.inventory.CraftItemStack.asCraftMirror(itemstack), (org.bukkit.entity.Projectile) entitythrownexpbottle.getBukkitEntity());
+            if (event.callEvent() && world.addFreshEntity(entitythrownexpbottle)) {
+                if (event.shouldConsume() && !entityhuman.abilities.instabuild) {
+                    itemstack.shrink(1);
+                } else if (entityhuman instanceof ServerPlayer) {
+                    ((ServerPlayer) entityhuman).getBukkitEntity().updateInventory();
+                }
+
+                world.playSound((Player) null, entityhuman.getX(), entityhuman.getY(), entityhuman.getZ(), SoundEvents.EXPERIENCE_BOTTLE_THROW, SoundSource.NEUTRAL, 0.5F, 0.4F / (Entity.SHARED_RANDOM.nextFloat() * 0.4F + 0.8F));
+                entityhuman.awardStat(Stats.ITEM_USED.get(this));
+            } else {
+                if (entityhuman instanceof ServerPlayer) {
+                    ((ServerPlayer) entityhuman).getBukkitEntity().updateInventory();
+                }
+                    return new InteractionResultHolder<ItemStack>(InteractionResult.FAIL, itemstack);
+            }
+            // Paper end
         }
 
-        entityhuman.awardStat(Stats.ITEM_USED.get(this));
-        if (!entityhuman.abilities.instabuild) {
-            itemstack.shrink(1);
+        /* // Paper start - moved up
+        entityhuman.b(StatisticList.ITEM_USED.b(this));
+        if (!entityhuman.abilities.canInstantlyBuild) {
+            itemstack.subtract(1);
         }
+        */ // Paper end
 
         return InteractionResultHolder.sidedSuccess(itemstack, world.isClientSide());
     }
diff --git a/src/main/java/net/minecraft/world/item/FireworkRocketItem.java b/src/main/java/net/minecraft/world/item/FireworkRocketItem.java
index c605e85d63d203c67a81dfa3eb38b61188708718..f34ac11723d2486254fe78d0e664ade7b2cf0d17 100644
--- a/src/main/java/net/minecraft/world/item/FireworkRocketItem.java
+++ b/src/main/java/net/minecraft/world/item/FireworkRocketItem.java
@@ -30,8 +30,12 @@ public class FireworkRocketItem extends Item {
             FireworkRocketEntity entityfireworks = new FireworkRocketEntity(world, itemactioncontext.getPlayer(), vec3d.x + (double) enumdirection.getStepX() * 0.15D, vec3d.y + (double) enumdirection.getStepY() * 0.15D, vec3d.z + (double) enumdirection.getStepZ() * 0.15D, itemstack);
             entityfireworks.spawningEntity = itemactioncontext.getPlayer().getUUID(); // Paper
 
-            world.addFreshEntity(entityfireworks);
-            itemstack.shrink(1);
+            // Paper start - PlayerLaunchProjectileEvent
+            com.destroystokyo.paper.event.player.PlayerLaunchProjectileEvent event = new com.destroystokyo.paper.event.player.PlayerLaunchProjectileEvent((org.bukkit.entity.Player) itemactioncontext.getPlayer().getBukkitEntity(), org.bukkit.craftbukkit.inventory.CraftItemStack.asCraftMirror(itemstack), (org.bukkit.entity.Firework) entityfireworks.getBukkitEntity());
+            if (!event.callEvent() || !world.addFreshEntity(entityfireworks)) return InteractionResult.PASS;
+            if (event.shouldConsume() && !itemactioncontext.getPlayer().abilities.instabuild) itemstack.shrink(1);
+            else if (itemactioncontext.getPlayer() instanceof ServerPlayer) ((ServerPlayer) itemactioncontext.getPlayer()).getBukkitEntity().updateInventory();
+            // Paper end
         }
 
         return InteractionResult.sidedSuccess(world.isClientSide);
diff --git a/src/main/java/net/minecraft/world/item/LingeringPotionItem.java b/src/main/java/net/minecraft/world/item/LingeringPotionItem.java
index 6b73bb9a628cf91571119fc02556e8d62d1ba05f..b693282bc7b4a21735b218a01fb41ca20d3be1d5 100644
--- a/src/main/java/net/minecraft/world/item/LingeringPotionItem.java
+++ b/src/main/java/net/minecraft/world/item/LingeringPotionItem.java
@@ -3,6 +3,7 @@ package net.minecraft.world.item;
 import net.minecraft.sounds.SoundEvents;
 import net.minecraft.sounds.SoundSource;
 import net.minecraft.world.InteractionHand;
+import net.minecraft.world.InteractionResult;
 import net.minecraft.world.InteractionResultHolder;
 import net.minecraft.world.entity.player.Player;
 import net.minecraft.world.level.Level;
@@ -15,7 +16,12 @@ public class LingeringPotionItem extends ThrowablePotionItem {
 
     @Override
     public InteractionResultHolder<ItemStack> use(Level world, Player entityhuman, InteractionHand enumhand) {
-        world.playSound((Player) null, entityhuman.getX(), entityhuman.getY(), entityhuman.getZ(), SoundEvents.LINGERING_POTION_THROW, SoundSource.NEUTRAL, 0.5F, 0.4F / (LingeringPotionItem.random.nextFloat() * 0.4F + 0.8F));
-        return super.use(world, entityhuman, enumhand);
+        // Paper start
+        InteractionResultHolder<ItemStack> wrapper = super.use(world, entityhuman, enumhand);
+        if (wrapper.getResult() != InteractionResult.FAIL) {
+            world.playSound((Player) null, entityhuman.getX(), entityhuman.getY(), entityhuman.getZ(), SoundEvents.LINGERING_POTION_THROW, SoundSource.NEUTRAL, 0.5F, 0.4F / (LingeringPotionItem.random.nextFloat() * 0.4F + 0.8F));
+        }
+        return wrapper;
+        // Paper end
     }
 }
diff --git a/src/main/java/net/minecraft/world/item/SnowballItem.java b/src/main/java/net/minecraft/world/item/SnowballItem.java
index 8284cff90f91f5afc82ef6f52b9810e7bee4c4b0..cfc5b6baf3a71d17ec4400afe4970b2ae9c3f891 100644
--- a/src/main/java/net/minecraft/world/item/SnowballItem.java
+++ b/src/main/java/net/minecraft/world/item/SnowballItem.java
@@ -5,6 +5,7 @@ import net.minecraft.sounds.SoundEvents;
 import net.minecraft.sounds.SoundSource;
 import net.minecraft.stats.Stats;
 import net.minecraft.world.InteractionHand;
+import net.minecraft.world.InteractionResult;
 import net.minecraft.world.InteractionResultHolder;
 import net.minecraft.world.entity.player.Player;
 import net.minecraft.world.entity.projectile.Snowball;
@@ -27,14 +28,20 @@ public class SnowballItem extends Item {
 
             entitysnowball.setItem(itemstack);
             entitysnowball.shootFromRotation(entityhuman, entityhuman.xRot, entityhuman.yRot, 0.0F, 1.5F, 1.0F);
-            if (world.addFreshEntity(entitysnowball)) {
-                if (!entityhuman.abilities.instabuild) {
+            // Paper start
+            com.destroystokyo.paper.event.player.PlayerLaunchProjectileEvent event = new com.destroystokyo.paper.event.player.PlayerLaunchProjectileEvent((org.bukkit.entity.Player) entityhuman.getBukkitEntity(), org.bukkit.craftbukkit.inventory.CraftItemStack.asCraftMirror(itemstack), (org.bukkit.entity.Projectile) entitysnowball.getBukkitEntity());
+            if (event.callEvent() && world.addFreshEntity(entitysnowball)) {
+                if (event.shouldConsume() && !entityhuman.abilities.instabuild) {
+                    // Paper end
                     itemstack.shrink(1);
+                } else if (entityhuman instanceof ServerPlayer) {  // Paper
+                    ((ServerPlayer) entityhuman).getBukkitEntity().updateInventory();  // Paper
                 }
 
                 world.playSound((Player) null, entityhuman.getX(), entityhuman.getY(), entityhuman.getZ(), SoundEvents.SNOWBALL_THROW, SoundSource.NEUTRAL, 0.5F, 0.4F / (SnowballItem.random.nextFloat() * 0.4F + 0.8F));
-            } else if (entityhuman instanceof ServerPlayer) {
-                ((ServerPlayer) entityhuman).getBukkitEntity().updateInventory();
+            } else { // Paper
+                if (entityhuman instanceof ServerPlayer) ((ServerPlayer) entityhuman).getBukkitEntity().updateInventory(); // Paper
+                return new InteractionResultHolder<ItemStack>(InteractionResult.FAIL, itemstack); // Paper
             }
         }
         // CraftBukkit end
diff --git a/src/main/java/net/minecraft/world/item/SplashPotionItem.java b/src/main/java/net/minecraft/world/item/SplashPotionItem.java
index 2a8bef50aedd435eec565e43490e8a681a328ae1..421021696204bc3d7cc09ca2b5b6011ead674110 100644
--- a/src/main/java/net/minecraft/world/item/SplashPotionItem.java
+++ b/src/main/java/net/minecraft/world/item/SplashPotionItem.java
@@ -3,6 +3,7 @@ package net.minecraft.world.item;
 import net.minecraft.sounds.SoundEvents;
 import net.minecraft.sounds.SoundSource;
 import net.minecraft.world.InteractionHand;
+import net.minecraft.world.InteractionResult;
 import net.minecraft.world.InteractionResultHolder;
 import net.minecraft.world.entity.player.Player;
 import net.minecraft.world.level.Level;
@@ -15,7 +16,12 @@ public class SplashPotionItem extends ThrowablePotionItem {
 
     @Override
     public InteractionResultHolder<ItemStack> use(Level world, Player entityhuman, InteractionHand enumhand) {
+        // Paper start
+        InteractionResultHolder<ItemStack> wrapper = super.use(world, entityhuman, enumhand);
+        if (wrapper.getResult() != InteractionResult.FAIL) {
         world.playSound((Player) null, entityhuman.getX(), entityhuman.getY(), entityhuman.getZ(), SoundEvents.SPLASH_POTION_THROW, SoundSource.PLAYERS, 0.5F, 0.4F / (SplashPotionItem.random.nextFloat() * 0.4F + 0.8F));
-        return super.use(world, entityhuman, enumhand);
+        }
+        return wrapper;
+        // Paper end
     }
 }
diff --git a/src/main/java/net/minecraft/world/item/ThrowablePotionItem.java b/src/main/java/net/minecraft/world/item/ThrowablePotionItem.java
index 17921342e7ec13eec6b30fe5b33ac0abc4fa68d5..05ecc559911c2ae91672f56374721cfe6a3db8bb 100644
--- a/src/main/java/net/minecraft/world/item/ThrowablePotionItem.java
+++ b/src/main/java/net/minecraft/world/item/ThrowablePotionItem.java
@@ -1,7 +1,9 @@
 package net.minecraft.world.item;
 
+import net.minecraft.server.level.ServerPlayer;
 import net.minecraft.stats.Stats;
 import net.minecraft.world.InteractionHand;
+import net.minecraft.world.InteractionResult;
 import net.minecraft.world.InteractionResultHolder;
 import net.minecraft.world.entity.player.Player;
 import net.minecraft.world.entity.projectile.ThrownPotion;
@@ -22,13 +24,31 @@ public class ThrowablePotionItem extends PotionItem {
 
             entitypotion.setItem(itemstack);
             entitypotion.shootFromRotation(entityhuman, entityhuman.xRot, entityhuman.yRot, -20.0F, 0.5F, 1.0F);
-            world.addFreshEntity(entitypotion);
+            // Paper start
+            com.destroystokyo.paper.event.player.PlayerLaunchProjectileEvent event = new com.destroystokyo.paper.event.player.PlayerLaunchProjectileEvent((org.bukkit.entity.Player) entityhuman.getBukkitEntity(), org.bukkit.craftbukkit.inventory.CraftItemStack.asCraftMirror(itemstack), (org.bukkit.entity.Projectile) entitypotion.getBukkitEntity());
+            if (event.callEvent() && world.addFreshEntity(entitypotion)) {
+                if (event.shouldConsume() && !entityhuman.abilities.instabuild) {
+                    itemstack.shrink(1);
+                } else if (entityhuman instanceof ServerPlayer) {
+                    ((ServerPlayer) entityhuman).getBukkitEntity().updateInventory();
+                }
+
+                entityhuman.awardStat(Stats.ITEM_USED.get(this));
+            } else {
+                if (entityhuman instanceof ServerPlayer) {
+                    ((ServerPlayer) entityhuman).getBukkitEntity().updateInventory();
+                }
+                    return new InteractionResultHolder<ItemStack>(InteractionResult.FAIL, itemstack);
+            }
+            // Paper end
         }
 
-        entityhuman.awardStat(Stats.ITEM_USED.get(this));
-        if (!entityhuman.abilities.instabuild) {
-            itemstack.shrink(1);
+        /* // Paper start - moved up
+        entityhuman.b(StatisticList.ITEM_USED.b(this));
+        if (!entityhuman.abilities.canInstantlyBuild) {
+            itemstack.subtract(1);
         }
+        */ // Paper end
 
         return InteractionResultHolder.sidedSuccess(itemstack, world.isClientSide());
     }
