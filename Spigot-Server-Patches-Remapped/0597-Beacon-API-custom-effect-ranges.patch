From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Jake Potrebic <jake.m.potrebic@gmail.com>
Date: Wed, 24 Jun 2020 12:39:08 -0600
Subject: [PATCH] Beacon API - custom effect ranges


diff --git a/src/main/java/net/minecraft/world/level/block/entity/BeaconBlockEntity.java b/src/main/java/net/minecraft/world/level/block/entity/BeaconBlockEntity.java
index 5e14a8f5ea9865a319bc7a5ef83133e99cf2cccc..7f49776ca9f887004453a060aac57b151be59987 100644
--- a/src/main/java/net/minecraft/world/level/block/entity/BeaconBlockEntity.java
+++ b/src/main/java/net/minecraft/world/level/block/entity/BeaconBlockEntity.java
@@ -73,6 +73,26 @@ public class BeaconBlockEntity extends BlockEntity implements MenuProvider, Tick
         return (hasSecondaryEffect()) ? CraftPotionUtil.toBukkit(new MobEffectInstance(this.secondaryPower, getLevelCb(), getAmplification(), true, true)) : null;
     }
     // CraftBukkit end
+    // Paper start - add field/methods for custom range
+    private final String PAPER_RANGE_TAG = "Paper.Range";
+    private double effectRange = -1;
+
+    public double getEffectRange() {
+        if (this.effectRange < 0) {
+            return this.levels * 10 + 10;
+        } else {
+            return effectRange;
+        }
+    }
+
+    public void setEffectRange(double range) {
+        this.effectRange = range;
+    }
+
+    public void resetEffectRange() {
+        this.effectRange = -1;
+    }
+    // Paper end
 
     public BeaconBlockEntity() {
         super(BlockEntityType.BEACON);
@@ -263,7 +283,8 @@ public class BeaconBlockEntity extends BlockEntity implements MenuProvider, Tick
 
     public List getHumansInRange() {
         {
-            double d0 = (double) (this.levels * 10 + 10);
+            // Paper - custom beacon ranges
+            double d0 = this.getEffectRange();
 
             AABB axisalignedbb = (new AABB(this.worldPosition)).inflate(d0).expandTowards(0.0D, (double) this.level.getMaxBuildHeight(), 0.0D);
             List<net.minecraft.world.entity.player.Player> list = this.level.getEntitiesOfClass(net.minecraft.world.entity.player.Player.class, axisalignedbb);
@@ -364,6 +385,9 @@ public class BeaconBlockEntity extends BlockEntity implements MenuProvider, Tick
         this.secondaryPower = MobEffect.byId(tag.getInt("Secondary"));
         this.levels = tag.getInt("Levels"); // SPIGOT-5053, use where available
         // CraftBukkit end
+        // Paper
+        this.effectRange = tag.contains(PAPER_RANGE_TAG, 6) ? tag.getDouble(PAPER_RANGE_TAG) : -1;
+
         if (tag.contains("CustomName", 8)) {
             this.name = Component.Serializer.fromJson(tag.getString("CustomName"));
         }
@@ -380,6 +404,8 @@ public class BeaconBlockEntity extends BlockEntity implements MenuProvider, Tick
         if (this.name != null) {
             tag.putString("CustomName", Component.Serializer.toJson(this.name));
         }
+        // Paper
+        tag.putDouble(PAPER_RANGE_TAG, this.effectRange);
 
         this.lockKey.addToTag(tag);
         return tag;
diff --git a/src/main/java/org/bukkit/craftbukkit/block/CraftBeacon.java b/src/main/java/org/bukkit/craftbukkit/block/CraftBeacon.java
index 639577ab8b6467302a243c99ba5a4eede3aed655..f4a5f3568f12d7701661759a1c586d4c8609fc7e 100644
--- a/src/main/java/org/bukkit/craftbukkit/block/CraftBeacon.java
+++ b/src/main/java/org/bukkit/craftbukkit/block/CraftBeacon.java
@@ -95,4 +95,19 @@ public class CraftBeacon extends CraftBlockEntityState<BeaconBlockEntity> implem
     public void setLock(String key) {
         this.getSnapshot().lockKey = (key == null) ? LockCode.NO_LOCK : new LockCode(key);
     }
+
+    @Override
+    public double getEffectRange() {
+        return this.getSnapshot().getEffectRange();
+    }
+
+    @Override
+    public void setEffectRange(double range) {
+        this.getSnapshot().setEffectRange(range);
+    }
+
+    @Override
+    public void resetEffectRange() {
+        this.getSnapshot().resetEffectRange();
+    }
 }
